/**
 * æ¸¸æˆç»“æœé¡µé¢
 * æ˜¾ç¤ºèƒœåˆ©æˆ–å¤±è´¥ç»“æœ
 */

import { Navigator } from '../utils/Navigator';
import { GameService } from '../services/GameService';
import { UserRepository } from '../repositories/UserRepository';
import { Color } from '../constants/Colors';
import { ColorValues } from '../constants/Colors';
import { StarRating } from '../components/StarRating';
import { ColorSlot } from '../components/ColorSlot';
import { ResponsiveUtils, RF, RSP, RS } from '../utils/ResponsiveUtils';

interface ResultParams {
  levelId: number;
  isWin: boolean;
  attempts: number;
  maxAttempts: number;
  password: Color[];
}

@Entry
@Component
struct ResultPage {
  @State levelId: number = 1;
  @State isWin: boolean = false;
  @State attempts: number = 0;
  @State maxAttempts: number = 7;
  @State stars: number = 0;
  @State password: Color[] = [];
  @State nextLevelId: number | null = null;

  async aboutToAppear() {
    ResponsiveUtils.init();
    // ä»è·¯ç”±å‚æ•°è·å–ç»“æœæ•°æ®
    const params = Navigator.getParams() as ResultParams;

    if (params) {
      this.levelId = params.levelId;
      this.isWin = params.isWin;
      this.attempts = params.attempts;
      this.maxAttempts = params.maxAttempts;
      this.password = params.password;

      // è®¡ç®—æ˜Ÿçº§
      if (this.isWin) {
        this.stars = GameService.calculateStars(this.attempts, this.maxAttempts);
      }

      // è·å–ä¸‹ä¸€å…³
      this.nextLevelId = await this.getNextLevel();
    }
  }

  /**
   * è·å–ä¸‹ä¸€å…³å¡ID
   */
  private async getNextLevel(): Promise<number | null> {
    try {
      const progress = await UserRepository.getUserProgress();
      let nextLevel: number | null = null;

      if (this.levelId <= 100) {
        // åˆçº§æ¨¡å¼
        if (this.levelId < progress.easyUnlocked && this.levelId < 100) {
          nextLevel = this.levelId + 1;
        }
      } else {
        // é«˜çº§æ¨¡å¼
        const hardLevelId = this.levelId - 100;
        if (hardLevelId < progress.hardUnlocked && hardLevelId < 500) {
          nextLevel = this.levelId + 1;
        }
      }

      return nextLevel;
    } catch (error) {
      console.error('Failed to get next level:', error);
      return null;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨ç»“æœå›¾æ ‡å’Œæ ‡é¢˜
      Column() {
        Text(this.isWin ? 'ğŸ‰' : 'ğŸ˜”')
          .fontSize(ResponsiveUtils.rf(RF.TITLE_XL) * 2)
          .margin({ bottom: ResponsiveUtils.rsp(RSP.L) })

        Text(this.isWin ? 'ç ´è§£æˆåŠŸ!' : 'ç ´è§£å¤±è´¥')
          .fontSize(ResponsiveUtils.rf(RF.TITLE_L))
          .fontWeight(FontWeight.Bold)
          .fontColor(this.isWin ? '#4CAF50' : '#F44336')

        if (this.isWin) {
          StarRating({
            stars: this.stars,
            starSize: ResponsiveUtils.rs(RS.ICON_SIZE)
          })
            .margin({ top: ResponsiveUtils.rsp(RSP.XS) })
        }
      }
      .margin({ top: ResponsiveUtils.rsp(RSP.XXL), bottom: ResponsiveUtils.rsp(RSP.L) })

      // ç»“æœè¯¦æƒ…å¡ç‰‡
      Column() {
        // å…³å¡ä¿¡æ¯
        this.ResultItem('å…³å¡', `ç¬¬ ${this.levelId} å…³`)
        this.ResultDivider()

        // å°è¯•æ¬¡æ•°
        this.ResultItem('å°è¯•æ¬¡æ•°', `${this.attempts} / ${this.maxAttempts}`)
        this.ResultDivider()

        // æ­£ç¡®å¯†ç 
        Column() {
          Text('æ­£ç¡®å¯†ç ')
            .fontSize(ResponsiveUtils.rf(RF.BODY_M))
            .fontColor('#757575')

          Row({ space: ResponsiveUtils.rsp(RSP.XS) }) {
            ForEach(this.password, (color: Color) => {
              ColorSlot({
                color: color,
                slotSize: ResponsiveUtils.rs(40),
                isClickable: false
              })
            })
          }
          .margin({ top: ResponsiveUtils.rsp(RSP.XS) })
        }
        .width('100%')
        .padding(ResponsiveUtils.rsp(RSP.XS))

        if (this.isWin) {
          this.ResultDivider()
          this.ResultItem('è¯„ä»·', this.getStarComment())
        }
      }
      .width('90%')
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({
        radius: 8,
        color: '#00000015',
        offsetX: 0,
        offsetY: 2
      })
      .margin({ bottom: ResponsiveUtils.rsp(RSP.L) })

      Blank()

      // æ“ä½œæŒ‰é’®
      Column({ space: ResponsiveUtils.rsp(RSP.XS) }) {
        // ä¸‹ä¸€å…³æŒ‰é’®
        if (this.isWin && this.nextLevelId) {
          Button('ä¸‹ä¸€å…³')
            .type(ButtonType.Normal)
            .backgroundColor('#2196F3')
            .fontColor('#FFFFFF')
            .borderRadius(8)
            .width('90%')
            .height(RS.BUTTON_HEIGHT)
            .onClick(() => {
              Navigator.replaceGame(this.nextLevelId!);
            })
        }

        // é‡æ–°æŒ‘æˆ˜
        Button('é‡æ–°æŒ‘æˆ˜')
          .type(ButtonType.Normal)
          .backgroundColor(this.isWin ? '#F5F5F5' : '#FF9800')
          .fontColor(this.isWin ? '#212121' : '#FFFFFF')
          .borderRadius(8)
          .width(this.isWin ? '90%' : '90%')
          .height(RS.BUTTON_HEIGHT)
          .onClick(() => {
            Navigator.replaceGame(this.levelId);
          })

        // è¿”å›å…³å¡é€‰æ‹©
        Button('è¿”å›å…³å¡é€‰æ‹©')
          .type(ButtonType.Normal)
          .backgroundColor('#FFFFFF')
          .fontColor('#757575')
          .borderRadius(8)
          .width('90%')
          .height(RS.BUTTON_HEIGHT)
          .onClick(() => {
            Navigator.pushLevelSelect(this.levelId <= 100 ? 'easy' : 'hard');
          })
      }
      .padding({ bottom: ResponsiveUtils.rsp(RSP.L) })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FAFAFA')
  }

  @Builder
  ResultItem(label: string, value: string) {
    Row() {
      Text(label)
        .fontSize(ResponsiveUtils.rf(RF.BODY_M))
        .fontColor('#757575')
        .width(ResponsiveUtils.rs(100))

      Text(value)
        .fontSize(ResponsiveUtils.rf(RF.BODY_L))
        .fontColor('#212121')
        .layoutWeight(1)
        .textAlign(TextAlign.End)
    }
    .width('100%')
    .padding(ResponsiveUtils.rsp(RSP.XS))
  }

  @Builder
  ResultDivider() {
    Divider()
      .color('#E0E0E0')
      .strokeWidth(1)
      .margin({ left: ResponsiveUtils.rsp(RSP.XS), right: ResponsiveUtils.rsp(RSP.XS) })
  }

  /**
   * è·å–æ˜Ÿçº§è¯„ä»·
   */
  private getStarComment(): string {
    switch (this.stars) {
      case 3:
        return 'å®Œç¾ç ´è§£ï¼';
      case 2:
        return 'è¡¨ç°ä¸é”™ï¼';
      case 1:
        return 'ç»§ç»­åŠªåŠ›ï¼';
      default:
        return '';
    }
  }
}
