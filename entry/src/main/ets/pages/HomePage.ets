/**
 * é¦–é¡µ
 * æ¸¸æˆä¸»èœå•ï¼Œæä¾›ä¸‰ç§æ¸¸æˆæ¨¡å¼å…¥å£
 */

import { Navigator } from '../utils/Navigator';
import { UserRepository, UserStats } from '../repositories/UserRepository';
import { GameConfig } from '../constants/GameConfig';
import { ResponsiveUtils, RF, RSP } from '../utils/ResponsiveUtils';

interface GameModeButtonOptions {
  title: string;
  description: string;
  icon: string;
  color: string;
  isLocked?: boolean;
  onClick: () => void;
}

@Builder
function GameModeButton(options: GameModeButtonOptions) {
  Column() {
    Row() {
      Text(options.icon)
        .fontSize(ResponsiveUtils.rf(RF.TITLE_M))
        .margin({ right: ResponsiveUtils.rsp(RSP.M) })

      Column() {
        Text(options.title)
          .fontSize(ResponsiveUtils.rf(RF.TITLE_M))
          .fontWeight(FontWeight.Medium)
          .fontColor(options.isLocked ? '#9E9E9E' : '#212121')

        Text(options.description)
          .fontSize(ResponsiveUtils.rf(RF.BODY_M))
          .fontColor('#757575')
          .margin({ top: ResponsiveUtils.rsp(RSP.XXS) })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      if (options.isLocked) {
        Text('ðŸ”’')
          .fontSize(ResponsiveUtils.rf(RF.BODY_L))
      } else {
        Text('>')
          .fontSize(ResponsiveUtils.rf(RF.BODY_L))
          .fontColor('#BDBDBD')
      }
    }
    .width('100%')
    .padding(ResponsiveUtils.rsp(RSP.M))
  }
  .width('100%')
  .backgroundColor('#FFFFFF')
  .borderRadius(12)
  .shadow({
    radius: 4,
    color: '#00000010',
    offsetX: 0,
    offsetY: 2
  })
  .border(options.isLocked ? {
    width: 1,
    color: '#E0E0E0'
  } : undefined)
  .onClick(options.onClick)
}

@Entry
@Component
struct HomePage {
  @State userStats: UserStats = {
    totalGames: 0,
    totalWins: 0,
    winRate: 0,
    bestStreak: 0,
    currentStreak: 0,
    easyUnlocked: 1,
    hardUnlocked: 0,
    totalStars: 0
  };
  @State isLoading: boolean = true;

  async aboutToAppear() {
    // åˆå§‹åŒ–å“åº”å¼å·¥å…·
    ResponsiveUtils.init();
    // åŠ è½½ç”¨æˆ·ç»Ÿè®¡æ•°æ®
    await this.loadUserStats();
  }

  /**
   * åŠ è½½ç”¨æˆ·ç»Ÿè®¡æ•°æ®
   */
  async loadUserStats() {
    try {
      this.userStats = await UserRepository.getUserStats();
      this.isLoading = false;
    } catch (error) {
      console.error('Failed to load user stats:', error);
      this.isLoading = false;
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Text('å¯†ç æœº')
        .fontSize(ResponsiveUtils.rf(RF.TITLE_XL))
        .fontWeight(FontWeight.Bold)
        .fontColor('#212121')
        .margin({ top: ResponsiveUtils.rsp(RSP.XL), bottom: ResponsiveUtils.rsp(RSP.M) })

      Text('ç ´è§£å¯†ç ï¼ŒæŒ‘æˆ˜æ™ºæ…§')
        .fontSize(ResponsiveUtils.rf(RF.BODY_L))
        .fontColor('#757575')
        .margin({ bottom: ResponsiveUtils.rsp(RSP.XL) })

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(ResponsiveUtils.rs(50))
            .height(ResponsiveUtils.rs(50))
            .color('#2196F3')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        // ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡
        Column() {
          Row() {
            Column() {
              Text(this.userStats.totalWins.toString())
                .fontSize(ResponsiveUtils.rf(RF.TITLE_L))
                .fontWeight(FontWeight.Bold)
                .fontColor('#2196F3')
              Text('èƒœåˆ©å±€æ•°')
                .fontSize(ResponsiveUtils.rf(RF.BODY_S))
                .fontColor('#757575')
                .margin({ top: ResponsiveUtils.rsp(RSP.XXS) })
            }
            .layoutWeight(1)

            Column() {
              Text(`${this.userStats.winRate}%`)
                .fontSize(ResponsiveUtils.rf(RF.TITLE_L))
                .fontWeight(FontWeight.Bold)
                .fontColor('#4CAF50')
              Text('èƒœçŽ‡')
                .fontSize(ResponsiveUtils.rf(RF.BODY_S))
                .fontColor('#757575')
                .margin({ top: ResponsiveUtils.rsp(RSP.XXS) })
            }
            .layoutWeight(1)

            Column() {
              Text(this.userStats.totalStars.toString())
                .fontSize(ResponsiveUtils.rf(RF.TITLE_L))
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFD700')
              Text('æ€»æ˜Ÿæ•°')
                .fontSize(ResponsiveUtils.rf(RF.BODY_S))
                .fontColor('#757575')
                .margin({ top: ResponsiveUtils.rsp(RSP.XXS) })
            }
            .layoutWeight(1)
          }
          .width('100%')
          .padding(ResponsiveUtils.rsp(RSP.M))
        }
        .width('90%')
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .shadow({
          radius: 8,
          color: '#00000015',
          offsetX: 0,
          offsetY: 2
        })
        .margin({ bottom: ResponsiveUtils.rsp(RSP.L) })

        // æ¸¸æˆæ¨¡å¼æŒ‰é’®
        Column({ space: ResponsiveUtils.rsp(RSP.S) }) {
          // å•äººé—¯å…³æ¨¡å¼
          GameModeButton({
            title: 'å•äººé—¯å…³',
            description: `åˆçº§: ${this.userStats.easyUnlocked}/${GameConfig.EASY_LEVEL_COUNT}å…³`,
            icon: 'ðŸŽ¯',
            color: '#2196F3',
            onClick: () => {
              Navigator.pushLevelSelect('easy');
            }
          })

          // é«˜çº§æŒ‘æˆ˜æ¨¡å¼
          GameModeButton({
            title: 'é«˜çº§æŒ‘æˆ˜',
            description: this.userStats.hardUnlocked > 0
              ? `é«˜çº§: ${this.userStats.hardUnlocked}/${GameConfig.HARD_LEVEL_COUNT}å…³`
              : 'éœ€é€šå…³åˆçº§æ¨¡å¼è§£é”',
            icon: 'ðŸ†',
            color: '#FF9800',
            isLocked: this.userStats.hardUnlocked === 0,
            onClick: () => {
              if (this.userStats.hardUnlocked > 0) {
                Navigator.pushLevelSelect('hard');
              }
            }
          })

          // ç»ƒä¹ æ¨¡å¼
          GameModeButton({
            title: 'ç»ƒä¹ æ¨¡å¼',
            description: 'éšæœºå¯†ç ï¼Œæ— é™ç»ƒä¹ ',
            icon: 'ðŸ’ª',
            color: '#4CAF50',
            onClick: () => {
              Navigator.pushPractice();
            }
          })

          // åŒäººå¯¹æˆ˜
          GameModeButton({
            title: 'åŒäººå¯¹æˆ˜',
            description: 'é¢å¯¹é¢PKï¼Œçœ‹è°æ›´èªæ˜Ž',
            icon: 'ðŸ‘¥',
            color: '#9C27B0',
            onClick: () => {
              Navigator.pushDuelSetup();
            }
          })
        }
        .width('90%')

        Blank()

        // åº•éƒ¨è®¾ç½®æŒ‰é’®
        Row() {
          Text('è®¾ç½®')
            .fontSize(ResponsiveUtils.rf(RF.BODY_M))
            .fontColor('#757575')
            .onClick(() => {
              Navigator.pushSettings();
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .padding({ bottom: ResponsiveUtils.rsp(RSP.XXL) })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FAFAFA')
  }
}
